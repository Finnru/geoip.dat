name: Build-GeoIP-Custom

on:
  workflow_dispatch:
  push:
    branches: [master, main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build Generator and Process
        run: |
          mkdir -p data output
          
          # Создаем файл проекта, чтобы Go не ругался
          [ -f go.mod ] || go mod init github.com/Finnru/geoip.dat

          # Пишем код упаковщика
          cat <<EOF > main.go
          package main

          import (
          	"bufio"
          	"encoding/binary"
          	"fmt"
          	"net"
          	"os"
          	"path/filepath"
          	"strings"
          )

          func writeVarint(v uint32) []byte {
          	buf := make([]byte, binary.MaxVarintLen32)
          	n := binary.PutUvarint(buf, uint64(v))
          	return buf[:n]
          }

          func encodeField(num int, wireType int, data []byte) []byte {
          	tag := uint32((num << 3) | wireType)
          	res := writeVarint(tag)
          	if wireType == 2 {
          		res = append(res, writeVarint(uint32(len(data)))...)
          	}
          	res = append(res, data...)
          	return res
          }

          func main() {
          	// Список категорий, которые мы оставляем
          	categories := []string{"private", "ru", "telegram"}
          	var allEntries []byte

          	for _, cat := range categories {
          		path := filepath.Join("data", cat)
          		// Если файла в data нет, попробуем создать заглушку для теста или взять существующий
          		if _, err := os.Stat(path); err != nil {
          			fmt.Printf("Category %s not found in data/, skipping...\n", cat)
          			continue
          		}

          		fmt.Printf("Packing %s...\n", strings.ToUpper(cat))
          		file, _ := os.Open(path)
          		scanner := bufio.NewScanner(file)
          		var cidrsData []byte
          		
          		for scanner.Scan() {
          			line := strings.TrimSpace(scanner.Text())
          			if line == "" || strings.HasPrefix(line, "#") { continue }
          			
          			_, ipnet, err := net.ParseCIDR(line)
          			if err == nil {
          				mask, _ := ipnet.Mask.Size()
          				ip := ipnet.IP.To4()
          				if ip == nil { ip = ipnet.IP.To16() }
          				
          				c := encodeField(1, 2, ip)
          				c = append(c, encodeField(2, 0, writeVarint(uint32(mask)))...)
          				cidrsData = append(cidrsData, encodeField(2, 2, c)...)
          			}
          		}
          		file.Close()

          		if len(cidrsData) > 0 {
          			geoIPData := encodeField(1, 2, []byte(strings.ToUpper(cat)))
          			geoIPData = append(geoIPData, cidrsData...)
          			allEntries = append(allEntries, encodeField(1, 2, geoIPData)...)
          		}
          	}

          	if len(allEntries) > 0 {
          		os.WriteFile("output/geoip.dat", allEntries, 0644)
          		fmt.Println("Done! geoip.dat saved to output/")
          	}
          }
          EOF

          # Запускаем сборку (как у «них»)
          go run main.go

      - name: Move and Checksum
        run: |
          mkdir -p publish
          cd output
          sha256sum geoip.dat > geoip.dat.sha256sum
          mv geoip.dat geoip.dat.sha256sum ../publish/

      - name: Commit data files
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add data/*
          git commit -m "Update data" || echo "No changes"
          git push

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: geoip-dist
          path: publish/*
