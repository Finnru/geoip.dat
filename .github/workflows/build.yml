name: Rebuild-GeoIP-From-Local

on:
  workflow_dispatch:
  push:
    branches: [master, main]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Extract and Rebuild
        run: |
          mkdir -p data
          
          cat <<EOF > builder.go
          package main

          import (
          	"bufio"
          	"bytes"
          	"encoding/binary"
          	"fmt"
          	"net"
          	"os"
          	"path/filepath"
          	"strings"
          )

          func writeVarint(v uint32) []byte {
          	buf := make([]byte, binary.MaxVarintLen32)
          	n := binary.PutUvarint(buf, uint64(v))
          	return buf[:n]
          }

          func encodeField(num int, wireType int, data []byte) []byte {
          	tag := uint32((num << 3) | wireType)
          	res := writeVarint(tag)
          	if wireType == 2 {
          		res = append(res, writeVarint(uint32(len(data)))...)
          	}
          	res = append(res, data...)
          	return res
          }

          func main() {
          	// 1. Читаем исходный файл из корня
          	source, err := os.ReadFile("geoip.dat")
          	if err != nil {
          		fmt.Printf("Error: geoip.dat not found in root: %v\n", err)
          		os.Exit(1)
          	}

          	// 2. Список того, что ищем
          	targets := []string{"RU", "TELEGRAM", "PRIVATE"}
          	
          	// Мы используем поиск по сигнатурам тегов в бинарном файле
          	for _, t := range targets {
          		fmt.Printf("Processing target: %s\n", t)
          		// В формате GeoIP тег идет как строка (Field 1)
          		// Ищем последовательность байт тега
          		tagBytes := []byte(t)
          		if !bytes.Contains(source, tagBytes) {
          			fmt.Printf("Warning: Tag %s not found in source\n", t)
          		}
          	}

          	// 3. Собираем новый файл из текстовых данных в папке data
          	// (Если ты хочешь, чтобы скрипт РЕАЛЬНО вырезал бинарные куски без утилит, 
          	// это требует полного парсера Protobuf. Пока мы пакуем то, что в data)
          	packFromData(targets)
          }

          func packFromData(targets []string) {
          	var allEntries []byte
          	for _, t := range targets {
          		path := filepath.Join("data", strings.ToLower(t))
          		file, err := os.Open(path)
          		if err != nil { continue }
          		
          		var cidrsData []byte
          		scanner := bufio.NewScanner(file)
          		for scanner.Scan() {
          			line := strings.TrimSpace(scanner.Text())
          			if line == "" { continue }
          			
          			_, ipnet, err := net.ParseCIDR(line)
          			if err == nil {
          				mask, _ := ipnet.Mask.Size()
          				c := encodeField(1, 2, ipnet.IP.To4())
          				if ipnet.IP.To4() == nil { c = encodeField(1, 2, ipnet.IP.To16()) }
          				c = append(c, encodeField(2, 0, writeVarint(uint32(mask)))...)
          				cidrsData = append(cidrsData, encodeField(2, 2, c)...)
          			}
          		}
          		file.Close()

          		if len(cidrsData) > 0 {
          			entry := encodeField(1, 2, []byte(t))
          			entry = append(entry, cidrsData...)
          			allEntries = append(allEntries, encodeField(1, 2, entry)...)
          			fmt.Printf("Packed %s successfully\n", t)
          		}
          	}
          	if len(allEntries) > 0 {
          		os.WriteFile("geoip_new.dat", allEntries, 0644)
          	}
          }
          EOF
          
          # Запускаем сборку
          go run builder.go

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/*
          if ! git diff --staged --quiet; then
            git commit -m "Sync filtered data"
            git push
          fi

      - name: Upload New GeoIP
        uses: actions/upload-artifact@v4
        with:
          name: rebuilt-geoip
          path: geoip_new.dat
